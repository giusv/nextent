(in-package :data)

(defprim remote (name schema url)
  (:pretty () (list 'remote (list :name name :schema (synth :pretty schema) :url (synth :pretty url))))
  (:html ()  (html:taglist
              (doc:text "Sorgente dati remota identificata come ")
              (html:span-color (string-downcase name))
              (doc:text ", istanza dello schema dati ~a " (doc:lower-camel (synth :name schema)))
              (doc:text "e popolata al caricamento dell'elemento tramite richiesta HTTP GET verso l'URL ")
              (html:p (html:code (synth :url url)))))
  (:template () ())
  (:controller () (bb-method (doc:text "get~a" (doc:upper-camel name))
                             nil
                             (bb-type 'observable :template (bb-type 'any :primitive t
                                                                     ;; (synth :name schema)
                                                                     :array t))
                             (bb-return (bb-chain (bb-dynamic 'this)
                                                  (bb-dynamic 'http)
                                                  (bb-call 'get (bb-const (synth :string (synth :url url))))
                                                  (bb-call 'map (bb-arrow (list (bb-pair 'res (bb-type 'response)))
                                                                          (bb-chain (bb-dynamic 'res)
                                                                                    (bb-call 'json))))
                                                  (bb-call 'catch (bb-arrow (list (bb-pair 'error (bb-type 'any :primitive t)))
                                                                            (bb-chain (bb-static 'observable)
                                                                                      (bb-call 'throw (bb-const "error")))))))))
  (:components (*) nil)
  (:imports () (list (bb-import "@angular/http" 'http 'response)
                     (bb-import "rxjs/Rx" 'observable)
                     (bb-import "rxjs/add/operator/map")
                     (bb-import "rxjs/add/operator/catch")
                     (synth :imports schema)
                     ;; (bb-import (mkstr "./" (string-downcase (synth :name schema))) (synth :name schema))
                     ))
  (:dependencies () (list (bb-pair 'http (bb-type 'http) :private t))))

(defprim rand (name schema)
  (:pretty () (list 'rand (list :name name :schema (synth :pretty schema))))
  (:html ()  (html:taglist
              (doc:text "Sorgente dati identificata come ")
              (html:span-color (string-downcase name))
              (doc:text ", istanza dello schema dati ~a " (doc:lower-camel (synth :name schema)))
              (doc:text "e popolata al caricamento dell'elemento tramite generazione casuale")))
  (:template () ())
  (:controller () (bb-pair name (bb-type 'any :primitive t) :init (synth :model (synth :random schema))))
  (:components (*) nil)
  (:imports () (list (synth :imports schema)
                     ;; (bb-import (mkstr "./" (string-downcase (synth :name schema))) (synth :name schema))
                     ))
  (:dependencies () nil))

(defprim with-data% (bindings element)
  (:pretty () (list 'with-data (list :bindings (synth-all :pretty bindings) :element (synth :pretty element))))
  (:req (path) (html:taglist (doc:text "Tale elemento fa uso delle seguenti sorgenti dati:")
                             (html:ul (mapcar #'listify (synth-all :req bindings))) 
                             (synth :req element path)))
  (:brief (path) (synth :brief element path))
  (:reqlist (path) (synth :reqlist element path))
  (:template () (synth :template element))
  (:controller () (bb-list (synth-all :controller bindings) ))
  (:components (*) nil)
  (:routes (path) nil)
  (:imports () (apply #'append (synth :imports element) (synth-all :imports bindings)))
  (:dependencies () (apply #'append (synth :dependencies element) (synth-all :dependencies bindings))))


(defmacro with-data (binds &body element)
  `(let* ,(mapcar #'(lambda (bind)
		      (destructuring-bind (name source) bind
			`(,name ,source)))
		  binds)
     (with-data% (list ,@(mapcar #'car binds)) ,@element)))

